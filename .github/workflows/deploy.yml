name: Snowflake Deploy Demo (DEV / PROD)

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install Snowflake CLI
      - name: Install Snowflake CLI
        run: |
          python3 -m pip install --upgrade pip
          pip install snowflake-cli-labs
          snow --version

      # 3. Set environment based on branch
      - name: Set Environment
        run: |
          if [ "${{ github.ref_name }}" = "dev" ]; then
            echo "ENV=DEV" >> $GITHUB_ENV
          else
            echo "ENV=PROD" >> $GITHUB_ENV
          fi

      # 4. Deploy SQL to Snowflake
      - name: Deploy to Snowflake
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        run: |
          echo "Deploying to environment: $ENV"

          # Replace ENV placeholder
          sed "s/{{ENV}}/$ENV/g" sql/01_database.sql > deploy_final.sql

          # Create Snowflake CLI connection (CORRECT syntax)
          snow connection add \
            --name default \
            --account $SF_ACCOUNT \
            --user $SF_USER \
            --password $SF_PASSWORD \
            --warehouse $SF_WAREHOUSE \
            --role ACCOUNTADMIN \
            --authenticator snowflake

          # Execute SQL
          snow sql \
            --connection default \
            --filename deploy_final.sql
