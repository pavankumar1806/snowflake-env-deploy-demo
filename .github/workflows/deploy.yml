name: Snowflake Single SQL Deploy (DEV / PROD)

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install SnowSQL (FIXED - follows redirects)
      - name: Install SnowSQL
        run: |
          curl -L https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-linux_x86_64 -o snowsql
          chmod +x snowsql
          sudo mv snowsql /usr/local/bin/snowsql
          snowsql --version

      # 3. Decide environment based on branch
      - name: Set Environment
        run: |
          if [ "${{ github.ref_name }}" = "dev" ]; then
            echo "ENV=DEV" >> $GITHUB_ENV
          else
            echo "ENV=PROD" >> $GITHUB_ENV
          fi

      # 4. Deploy single SQL file
      - name: Deploy to Snowflake
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        run: |
          echo "Deploying to environment: $ENV"
          sed "s/{{ENV}}/$ENV/g" deploy.sql | \
          snowsql \
            -a $SF_ACCOUNT \
            -u $SF_USER \
            -p $SF_PASSWORD \
            -w $SF_WAREHOUSE \
            -r ACCOUNTADMIN \
            -f -
